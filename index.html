<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RAPEEPHAT REMIX - Studio</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/wavesurfer.js@7/dist/wavesurfer.min.js"></script>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
body{font-family:'Kanit',sans-serif;background:#0f172a;color:#fff}
.glass{backdrop-filter:blur(10px);background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1)}
</style>
</head>

<body class="pb-40">

<header class="glass p-4 flex justify-between items-center sticky top-0 z-50">
<h1 class="text-cyan-400 font-bold">
<i class="fas fa-compact-disc fa-spin mr-2"></i>RAPEEPHAT REMIX
</h1>
<label class="bg-cyan-600 px-4 py-2 rounded-full cursor-pointer">
<i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏•‡∏á
<input type="file" id="uploadInput" accept="audio/*" hidden>
</label>
</header>

<section class="p-6 space-y-6">

<div id="playerView" class="glass p-6 rounded-3xl hidden">
<h2 id="currentTitle" class="text-xl font-bold text-cyan-400"></h2>
<p id="currentViews" class="text-xs opacity-50 mb-2"></p>
<div id="waveform"></div>
</div>

<div id="playlist" class="grid gap-3"></div>
</section>

<script>
// ================= Firebase =================
firebase.initializeApp({
apiKey: "AIzaSyAA4KDuxv3FoaYi7RAgm0_ypb8RdBVXGak",
authDomain: "myrpt-14f92.firebaseapp.com",
projectId: "myrpt-14f92",
storageBucket: "myrpt-14f92.firebasestorage.app",
messagingSenderId: "463177303761",
appId: "1:463177303761:web:6fd2559de7f610d6f2a7f0"
});

const db = firebase.firestore();
const storage = firebase.storage();

// ================= Audio Element (FIX) =================
const audioEl = document.createElement('audio');
audioEl.crossOrigin = "anonymous";
audioEl.preload = "auto";

// ================= WaveSurfer (FIX ‡∏ä‡∏±‡∏ß‡∏£‡πå) =================
const ws = WaveSurfer.create({
container: '#waveform',
backend: 'MediaElement',
media: audioEl,              // üî• ‡∏ú‡∏π‡∏Å audio ‡∏ï‡∏£‡∏á ‡πÜ
waveColor: '#475569',
progressColor: '#22d3ee',
cursorColor: '#22d3ee',
height: 80,
responsive: true
});

// ================= Upload =================
uploadInput.onchange = async e => {
const file = e.target.files[0];
if(!file) return;

const ref = storage.ref('songs/' + Date.now() + '_' + file.name);
await ref.put(file);
const url = await ref.getDownloadURL();

await db.collection("songs").add({
title: file.name.replace(/\..+/, ''),
url,
path: ref.fullPath,
views: 0,
created: firebase.firestore.FieldValue.serverTimestamp()
});

alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß");
};

// ================= Load Songs =================
db.collection("songs").orderBy("created","desc")
.onSnapshot(snap=>{
playlist.innerHTML = snap.docs.map(d=>{
const s = d.data();
return `
<div class="glass p-4 rounded-xl flex justify-between items-center">
<div class="cursor-pointer" onclick="playSong('${d.id}','${s.url}','${s.title}',${s.views})">
<b>${s.title}</b>
<div class="text-xs opacity-50">üëÅ ${s.views} views</div>
</div>
<button onclick="deleteSong('${d.id}','${s.path}')" class="text-red-400">
<i class="fas fa-trash"></i>
</button>
</div>`;
}).join('');
});

// ================= Play + View (FIX) =================
function playSong(id, url, title, views){
playerView.classList.remove('hidden');
currentTitle.innerText = title;
currentViews.innerText = `üëÅ ${views + 1} views`;

// reset state ‡∏Å‡∏±‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á
ws.pause();
ws.empty();

// ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
ws.load(url);

// unlock + play
ws.once('ready', () => {
audioEl.currentTime = 0;
audioEl.play().catch(()=>{}); // ‡∏Å‡∏±‡∏ô browser block
});

// update view
db.collection("songs").doc(id).update({
views: firebase.firestore.FieldValue.increment(1)
});
}

// ================= Delete =================
async function deleteSong(id, path){
if(!confirm("‡∏•‡∏ö‡πÄ‡∏û‡∏•‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡∏≤‡∏ß‡∏£?")) return;

await storage.ref(path).delete();
await db.collection("songs").doc(id).delete();

alert("‡∏•‡∏ö‡πÄ‡∏û‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß");
}
</script>

</body>
</html>
